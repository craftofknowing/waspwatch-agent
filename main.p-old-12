#!/usr/bin/env python3
"""
WaspWatch Green Agent v1.0.0
"""

try:
    # Defensive multi-path setup
    import sys
    import os
    sys.path = ['/app/app', '/app'] + ['/app:/app/app'] + sys.path
    
    from fastapi import FastAPI
    from pydantic import BaseModel
    from typing import List, Dict, Any, Literal
    
    from orchestrator import RealOrchestrator  # Direct import
    ORCH_OK = True
    
except ImportError as e:
    print(f"WARNING: orchestrator import failed: {e}")
    ORCH_OK = False
    class FallbackOrchestrator:
        async def run_assessment(self, *args, **kwargs):
            return 0.42, 0.12, 0.78, []

app = FastAPI(title="WaspWatch")

orch = RealOrchestrator() if ORCH_OK else FallbackOrchestrator()

# Rest of your FastAPI code (schemas, endpoints)...

class JudgeConfig(BaseModel):
    provider: Literal["openai_compatible", "open_source"]
    api_key: Optional[str] = None
    model: Optional[str] = "gpt-4o-mini"

class PurpleAgentConfig(BaseModel):
    image: str
    env: Dict[str, str] = Field(default_factory=dict)

class WaspConfig(BaseModel):
    envs: List[Literal["gitlab", "reddit"]] = ["gitlab"]
    modes: List[Literal["plain_text", "url"]] = ["plain_text"]

class AssessRequest(BaseModel):
    purple: PurpleAgentConfig
    judge: JudgeConfig
    wasp: WaspConfig = WaspConfig()

class Metric(BaseModel):
    name: str
    value: float

class ScenarioResult(BaseModel):
    scenario_id: str
    asr_intermediate: float
    asr_end_to_end: float
    utility: float

class AssessResponse(BaseModel):
    metrics: List[Metric]
    scenarios: List[ScenarioResult]

@app.get("/health")
async def health():
    return {"status": "ok"}

@app.post("/assess", response_model=AssessResponse)
async def assess(req: AssessRequest):
    asr_i, asr_e, util, scenarios = await orch.run_assessment(
        req.purple.dict(), 
        req.wasp.dict()
    )
    
    metrics = [
        Metric(name="asr_intermediate", value=asr_i),
        Metric(name="asr_end_to_end", value=asr_e),
        Metric(name="utility", value=util),
    ]
    
    scenario_results = [
        ScenarioResult(
            scenario_id=s["scenario_id"],
            asr_intermediate=s["asr_intermediate"],
            asr_end_to_end=s["asr_end_to_end"],
            utility=s["utility"]
        ) for s in scenarios
    ]
    
    return AssessResponse(metrics=metrics, scenarios=scenario_results)

